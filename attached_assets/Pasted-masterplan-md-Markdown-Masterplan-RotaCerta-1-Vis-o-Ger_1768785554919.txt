masterplan.md
Markdown

# Masterplan: RotaCerta

## 1. Vis√£o Geral do Projeto
O **RotaCerta** √© um aplicativo Web (PWA) de log√≠stica e gest√£o financeira focado em entregadores aut√¥nomos no Brasil. O objetivo √© replicar a efici√™ncia de roteiriza√ß√£o do "Circuit", eliminando a necessidade de leitura de c√≥digo de barras e introduzindo um controle financeiro robusto integrado ao status das entregas.

**Miss√£o:** Simplificar a vida do entregador, otimizando seu tempo na rua e garantindo transpar√™ncia total sobre seus ganhos di√°rios.

## 2. P√∫blico-Alvo
* **Persona Principal:** Entregadores aut√¥nomos (Last Mile) que utilizam ve√≠culo pr√≥prio ou agregado.
* **Dores:** Perda de tempo planejando rotas manualmente, dificuldade em controlar ganhos vari√°veis, digita√ß√£o lenta de endere√ßos.

## 3. Principais Funcionalidades
* **Entrada H√≠brida:** Digita√ß√£o inteligente com autocomplete ou Entrada por Voz (Speech-to-Text nativo).
* **Otimiza√ß√£o Inteligente (TSP):** Algoritmo Mapbox para organizar paradas da maneira mais eficiente.
* **Identifica√ß√£o Fixa:** Cada pacote recebe um n√∫mero fixo (1, 2, 3...) que persiste mesmo ap√≥s reordenar a rota.
* **Gest√£o Visual de Status:** Marcadores coloridos no mapa indicando o estado atual da entrega.
* **M√≥dulo Financeiro:** C√°lculo autom√°tico (R$ 2,80/entrega) + Regras de bonifica√ß√£o de Domingo.
* **Relat√≥rios:** Dashboard em tempo real e exporta√ß√£o de PDF quinzenal.

## 4. Stack Tecnol√≥gica
* **Frontend:** React 19, Tailwind CSS 4, TypeScript, Shadcn/ui.
* **Backend:** Node.js (Express) hospedado na Qnax, tRPC v11.
* **Database & Auth:** Supabase (PostgreSQL).
* **Mapas & Geo:** Mapbox GL JS, Geocoding API v6, Optimization API v1, Directions API v5.
* **State Management:** Zustand + TanStack Query.

## 5. Modelo de Neg√≥cio (L√≥gica Interna)
* O app √© uma ferramenta de produtividade.
* **C√°lculo de Ganhos:**
    * Base: R$ 2,80 por entrega com status "Entregue".
    * B√¥nus: Se (Dia == Domingo) E (Entregas > 50) ‚Üí +R$ 100,00.

## 6. Seguran√ßa e Privacidade
* Dados de localiza√ß√£o processados via HTTPS.
* Autentica√ß√£o via Supabase Auth.
* Dados sens√≠veis de rota armazenados apenas pelo tempo necess√°rio (ou hist√≥rico do usu√°rio).
implementation-plan.md
Markdown

# Plano de Implementa√ß√£o: RotaCerta

Este documento detalha a execu√ß√£o t√©cnica, incluindo schemas de banco de dados e componentes cr√≠ticos solicitados.

## Fase 1: Configura√ß√£o do Ambiente
1.  **Repo Setup:** Monorepo ou estrutura Frontend/Backend separada.
2.  **Frontend:** Vite + React 19 + Tailwind 4 + Shadcn/ui init.
3.  **Backend:** Express server setup com tRPC. Hospedagem na Qnax.
4.  **Supabase:** Cria√ß√£o do projeto e configura√ß√£o do Auth.

## Fase 2: Modelagem de Dados (Supabase SQL)

Copie e rode este script no SQL Editor do Supabase:

```sql
-- Habilitar extens√£o de UUID
create extension if not exists "uuid-ossp";

-- Tabela de Itiner√°rios (Dia de trabalho)
create table itineraries (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references auth.users(id) not null,
  date date default current_date not null,
  status text check (status in ('active', 'completed')) default 'active',
  total_earnings numeric(10, 2) default 0.00,
  created_at timestamp with time zone default now()
);

-- Tabela de Paradas (Stops)
create table stops (
  id uuid default uuid_generate_v4() primary key,
  itinerary_id uuid references itineraries(id) on delete cascade not null,
  fixed_identifier text not null, -- O n√∫mero escrito no pacote (ex: "1", "15")
  address_full text not null,
  latitude double precision not null,
  longitude double precision not null,
  sequence_order integer not null, -- Ordem otimizada (1, 2, 3...)
  status text check (status in ('pending', 'current', 'delivered', 'failed')) default 'pending',
  delivery_time timestamp with time zone,
  notes text,
  created_at timestamp with time zone default now()
);

-- Tabela de Cache Financeiro (Resumo)
create table financial_summaries (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references auth.users(id) not null,
  period_start date not null,
  period_end date not null,
  total_deliveries integer default 0,
  total_amount numeric(10, 2) default 0.00,
  bonus_applied boolean default false,
  generated_at timestamp with time zone default now()
);

-- √çndices para performance
create index idx_stops_itinerary on stops(itinerary_id);
create index idx_stops_status on stops(status);
Fase 3: Backend (tRPC & Mapbox Integration)
Defini√ß√£o dos Procedimentos (Pseudo-c√≥digo tRPC)
TypeScript

// router/stops.ts
export const stopsRouter = router({
  // 1. Adicionar Parada
  addStop: protectedProcedure
    .input(z.object({ 
      address: z.string(), 
      itineraryId: z.string() 
    }))
    .mutation(async ({ input, ctx }) => {
      // 1. Chamar Mapbox Geocoding V6 para pegar Lat/Long
      // 2. Gerar next fixed_identifier (Count + 1)
      // 3. Insert no Supabase
    }),

  // 2. Otimizar Rota (Core)
  optimizeRoute: protectedProcedure
    .input(z.object({ itineraryId: z.string(), currentLat: z.number(), currentLng: z.number() }))
    .mutation(async ({ input, ctx }) => {
      // 1. Buscar todas as paradas 'pending' do itiner√°rio
      // 2. Montar payload para Mapbox Optimization API
      // 3. Receber array ordenado
      // 4. ATUALIZAR apenas a coluna 'sequence_order' no banco
      // IMPORTANTE: N√£o alterar o 'fixed_identifier'
    }),

  // 3. Atualizar Status (Financeiro Trigger)
  updateStatus: protectedProcedure
    .input(z.object({ stopId: z.string(), status: z.enum(['delivered', 'failed']) }))
    .mutation(async ({ input, ctx }) => {
      // 1. Update na tabela stops
      // 2. Se 'delivered', recalcular earnings do itinerary
      // 3. Verificar regra de Domingo (Is Sunday? > 50 stops?)
      // 4. Update total_earnings
    }),
});
L√≥gica de "Re-otimiza√ß√£o"
Quando o usu√°rio pede para re-otimizar:

O sistema filtra apenas paradas com status = 'pending'.

A localiza√ß√£o atual do usu√°rio (GPS) √© definida como o ponto de partida (start).

A API retorna a nova ordem.

O Backend atualiza o sequence_order no banco.

O Frontend invalida a query e redesenha a linha (Directions API). Nota: O pacote marcado com caneta como "5" continua sendo o "5" na UI (Fixed ID), mas pode ser o 1¬∫ da nova lista.

Fase 4: Frontend Components (React 19)
AddressInput.tsx (Voz e Autocomplete)
TypeScript

import { useState } from 'react';
import { Mic, Search } from 'lucide-react';

export function AddressInput({ onSelectAddress }: { onSelectAddress: (addr: string) => void }) {
  const [query, setQuery] = useState('');
  const [isListening, setIsListening] = useState(false);

  const startListening = () => {
    // Verifica√ß√£o de compatibilidade
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("Seu navegador n√£o suporta entrada de voz.");
      return;
    }

    const recognition = new SpeechRecognition();
    recognition.lang = 'pt-BR';
    recognition.continuous = false;

    recognition.onstart = () => setIsListening(true);
    recognition.onend = () => setIsListening(false);
    
    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      setQuery(transcript);
      // Opcional: Trigger busca autom√°tica aqui
    };

    recognition.start();
  };

  // Implementar debounce para chamar Mapbox Geocoding ao digitar
  
  return (
    <div className="relative w-full">
      <input 
        type="text" 
        value={query}
        onChange={(e) => setQuery(e.target.value)}
        placeholder="Digite ou fale o endere√ßo..."
        className="w-full p-4 pl-10 pr-12 border rounded-lg shadow-sm"
      />
      <Search className="absolute left-3 top-4 w-5 h-5 text-gray-400" />
      
      <button 
        onClick={startListening}
        className={`absolute right-2 top-2 p-2 rounded-full transition-colors ${
          isListening ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-gray-100 text-gray-600'
        }`}
      >
        <Mic className="w-5 h-5" />
      </button>
    </div>
  );
}
RouteMap.tsx (Visualiza√ß√£o com Cores)
TypeScript

import Map, { Marker, Source, Layer } from 'react-map-gl'; // Mapbox wrapper

// Cores baseadas no Status
const STATUS_COLORS = {
  pending: '#3B82F6',   // Azul (Tailwind blue-500)
  current: '#22C55E',   // Verde (Tailwind green-500) - A pr√≥xima
  delivered: '#9CA3AF', // Cinza (Tailwind gray-400)
  failed: '#EF4444',    // Vermelho (Tailwind red-500)
};

export function RouteMap({ stops, routeGeoJSON }) {
  return (
    <Map
      initialViewState={{ longitude: -46.63, latitude: -23.55, zoom: 12 }}
      mapStyle="mapbox://styles/mapbox/streets-v12"
      mapboxAccessToken={process.env.NEXT_PUBLIC_MAPBOX_TOKEN}
    >
      {/* Linha da Rota */}
      {routeGeoJSON && (
        <Source id="route" type="geojson" data={routeGeoJSON}>
          <Layer
            id="route-line"
            type="line"
            paint={{ 'line-color': '#3B82F6', 'line-width': 4 }}
          />
        </Source>
      )}

      {/* Marcadores */}
      {stops.map((stop) => (
        <Marker 
          key={stop.id} 
          longitude={stop.longitude} 
          latitude={stop.latitude}
        >
          <div 
            className="flex items-center justify-center w-8 h-8 rounded-full text-white font-bold shadow-lg border-2 border-white"
            style={{ backgroundColor: STATUS_COLORS[stop.status] }}
          >
            {stop.fixed_identifier}
          </div>
        </Marker>
      ))}
    </Map>
  );
}
Fase 5: Integra√ß√£o Financeira e PDF
Criar hook useEarnings que subscreve √†s mudan√ßas na tabela itineraries.

Implementar jsPDF ou react-pdf para gerar o relat√≥rio quinzenal buscando dados de financial_summaries.


---

### design-guidelines.md

```markdown
# Diretrizes de Design & UX: RotaCerta

## 1. Identidade Visual
* **Estilo:** Utilit√°rio, Limpo, Alto Contraste (para uso sob luz solar).
* **Fonte:** Inter ou Roboto (Padr√£o Shadcn).

## 2. Paleta de Cores (Sem√¢ntica)
O uso de cores √© funcional, n√£o est√©tico.
* **üîµ Azul (Primary):** A√ß√µes principais, Rotas, Paradas pendentes.
* **üü¢ Verde (Success):** Parada atual (foco), Dinheiro/Lucro, Confirma√ß√£o de entrega.
* **‚ö™ Cinza (Neutral):** Paradas conclu√≠das (diminuir carga cognitiva), textos secund√°rios.
* **üî¥ Vermelho (Destructive):** Falha na entrega, Erros, Bot√£o de cancelar.

## 3. UX para Entregadores (Mobile First)
* **Bot√µes Grandes:** Zonas de toque de min 48px (facilitar clique com luvas ou movimento).
* **Feedback de Voz:** Ao ditar endere√ßo, mostrar visualmente a onda sonora ou texto sendo digitado em tempo real.
* **Modo Foco:** Durante a navega√ß√£o, ocultar menus desnecess√°rios. Mostrar apenas: Pr√≥xima Parada + Bot√£o Waze + Bot√µes de Status (Entregue/Falhou).

## 4. Componentes Chave (Shadcn/ui)
* `Card`: Para exibir detalhes de cada parada na lista.
* `Button`: Variantes `default`, `destructive` e `outline` para a√ß√µes de rota.
* `Drawer` (Mobile): Para detalhes da parada sem sair do mapa.
* `Toast`: Para confirmar "Entrega registrada + R$ 2,80".
app-flow-pages-and-roles.md
Markdown

# Fluxo, P√°ginas e Pap√©is: RotaCerta

## 1. Pap√©is de Usu√°rio
* **Entregador (User):** √önico papel no MVP. Acesso total aos seus pr√≥prios dados.

## 2. Estrutura de P√°ginas

### A. Autentica√ß√£o
* `/login`: Login via Magic Link ou Google (Supabase Auth).

### B. Fluxo Principal (Dia a Dia)
1.  **Home / Setup de Rota** (`/app/plan`)
    * Bot√£o grande: "Novo Itiner√°rio".
    * Lista de endere√ßos vazia.
    * Input fixo no rodap√© (Texto + Microfone).
    * A√ß√£o: Adicionar endere√ßos -> Clicar "Otimizar Rota".

2.  **Modo Navega√ß√£o** (`/app/drive`)
    * **Tela Dividida (ou Mapa Full com Card Flutuante):**
        * Mapa com linha azul e pinos.
        * Card da "Parada Atual" (Verde).
    * **A√ß√µes no Card:**
        * Bot√£o "Navegar" (Abre Waze/Gmaps).
        * Bot√£o "Entregue" (Muda status -> Cinza -> Toca som de caixa registradora -> Soma R$ 2,80).
        * Bot√£o "Falhou".
    * **Menu Flutuante:** "Re-otimizar" (caso pule uma parada).

### C. Gest√£o Financeira (`/app/finance`)
* **Dashboard:**
    * Ganhos Hoje (Barra de progresso da meta).
    * Ganhos Quinzenais.
    * Indicador de "B√¥nus de Domingo" (Ativo/Inativo).
* **Hist√≥rico:** Lista de dias passados.
* **Exportar:** Bot√£o "Gerar Relat√≥rio PDF".

## 3. Fluxo de Navega√ß√£o Detalhado (Happy Path)
1.  Abre o app -> Login autom√°tico.
2.  Cria rota -> Dita 50 endere√ßos (Voz).
3.  Clica "Otimizar".
4.  App numera os pacotes na tela (1 a 50). Entregador escreve nos pacotes f√≠sicos.
5.  Entregador clica "Iniciar Rota".
6.  App foca no Ponto 1 (Verde).
7.  Entregador clica "Navegar" -> Vai pro Waze -> Faz entrega -> Volta pro App.
8.  Clica "Confirmar Entrega".
9.  Ponto 1 vira Cinza. Ponto 2 vira Verde. Saldo atualiza (+R$ 2,80).
10. Repete at√© o fim.